# OpenWebUI 三权分立定制版部署与使用指南

## 1. 简介

本文档旨在指导您部署和使用基于 OpenWebUI v0.6.5 定制开发的三权分立版本。本次定制开发的核心目标是遵循分级保护和三权分立的安全原则，将原有的超级管理员（`admin`）权限拆分为三个相互独立的管理员角色：

- **系统管理员 (System Admin)**
- **授权管理员 (Auth Admin)**
- **安全审计员 (Audit Admin)**

这种设计增强了系统的安全性和问责制，确保不同职责的管理员拥有最小必要权限，并对所有关键操作进行审计。

## 2. 角色定义

三个新设立的管理员角色职责明确，权限分离，具体如下：

| 角色 | 英文标识 | 主要职责 |
| :--- | :--- | :--- |
| **系统管理员** | `system_admin` | 负责系统的日常运行和维护，管理模型、配置、工具等核心功能。接管了原超级管理员除用户管理和审计外的所有功能。 |
| **授权管理员** | `auth_admin` | 负责用户和权限管理，包括创建用户、分配角色、重置密码等。 |
| **安全审计员** | `audit_admin` | 负责审计系统中的所有活动，包括所有用户（含其他管理员）的操作日志和登录日志。拥有独立的审计前端界面。 |

原有的 `admin` 角色在首次部署后将不再使用，系统会自动将第一个注册的用户设置为 **系统管理员**。

## 3. 系统部署

我们提供了一个自动化部署脚本 `DEPLOY.sh` 来简化部署流程。请确保您的服务器环境满足以下基本要求。

### 3.1. 环境要求

- **操作系统**: Ubuntu 22.04 或其他兼容的 Linux 发行版
- **Python**: 3.10 或更高版本
- **Node.js**: 18.0 或更高版本
- **Git**: 用于克隆代码

### 3.2. 自动化部署

1.  **获取代码**: 将我们提供的 `open-webui-custom.zip` 压缩包上传到您的服务器并解压。

    ```bash
    unzip open-webui-custom.zip
    cd open-webui
    ```

2.  **运行部署脚本**: 执行 `DEPLOY.sh` 脚本，它将自动完成所有依赖安装、数据库迁移和前端构建工作。

    ```bash
    chmod +x DEPLOY.sh
    ./DEPLOY.sh
    ```

3.  **配置环境变量**: 脚本执行成功后，您需要根据 `.env.example` 文件创建一个 `.env` 文件，并根据您的实际环境进行配置。

    ```bash
    cp backend/.env.example backend/.env
    # 使用 vim 或 nano 编辑 backend/.env 文件
    nano backend/.env
    ```

4.  **启动服务**: 启动后端服务。

    ```bash
    cd backend
    ./start.sh
    ```

服务启动后，您可以通过 `http://<您的服务器IP>:8080` 访问 OpenWebUI。

## 4. 初始设置与使用指南

### 4.1. 创建管理员账户

1.  **创建系统管理员**: 部署完成后，访问 WebUI 并注册第一个用户。**系统会自动将第一个注册的用户设置为 `system_admin`（系统管理员）**。

2.  **创建授权和审计管理员**: 
    - 系统管理员登录后，是没有权限创建用户的。
    - 您需要**再次注册**两个新用户，例如 `auth-admin@example.com` 和 `audit-admin@example.com`。这两个用户初始角色为 `pending`（待审核）。
    - 联系拥有数据库访问权限的人员，或通过数据库管理工具（如 DBeaver, pgAdmin）直接修改 `users` 表，将这两个用户的 `role` 字段分别更新为 `auth_admin` 和 `audit_admin`。

    ```sql
    -- 将用户角色更新为授权管理员
    UPDATE users SET role = 'auth_admin' WHERE email = 'auth-admin@example.com';

    -- 将用户角色更新为安全审计员
    UPDATE users SET role = 'audit_admin' WHERE email = 'audit-admin@example.com';
    ```

### 4.2. 授权管理员使用指南

授权管理员登录后，将看到“用户管理”界面。其主要职责是：

- **查看用户列表**: 访问“设置” -> “用户”，可以查看系统中的所有用户及其角色。
- **分配角色**: 可以将 `pending` 状态的用户审批通过，并分配为 `user`（普通用户）。也可以在 `system_admin`, `auth_admin`, `audit_admin` 之间调整其他管理员的角色。
- **创建用户**: 可以直接创建新用户。

### 4.3. 安全审计员使用指南

安全审计员登录后，将看到全新的“安全审计”专属界面。其主要职责是：

- **审计仪表盘**: 默认页面展示过去7天的核心安全事件统计，包括总操作数、失败操作数、登录总次数和失败次数等。
- **审计日志查询**: 
    - 导航至“审计日志查询”页面。
    - 可以根据用户ID、用户角色、操作类型、资源类型、时间范围和IP地址等多种条件筛选查询所有用户的操作记录。
    - 点击“详情”可以查看每个操作的完整请求和响应体。
- **登录日志查询**: 
    - 导航至“登录日志查询”页面。
    - 可以根据用户邮箱、登录方式、登录状态、时间范围和IP地址等条件筛选查询所有用户的登录尝试记录。

## 5. 技术实现细节

### 5.1. 后端

- **数据库模型**: 
    - 新增 `audit_log` 表，用于存储详细的操作审计日志。
    - 新增 `login_log` 表，用于存储用户登录尝试记录。
- **权限装饰器**: 在 `open_webui.utils.auth` 中新增了 `get_system_admin`, `get_auth_admin`, `get_audit_admin` 等 FastAPI 依赖项，用于保护相关 API 端点。
- **审计中间件**: 增强了 `AuditLoggingMiddleware`，将所有通过验证的 API 请求的关键信息（除敏感数据外）异步存入 `audit_log` 数据库表。
- **API 路由**: 
    - 新增 `/api/v1/audit` 路由，提供对审计日志和登录日志的查询、统计功能，仅限安全审计员访问。
    - 修改了 `/api/v1/users` 路由下的权限，将用户管理权限严格限制给授权管理员。

### 5.2. 前端

- **SvelteKit 路由**: 
    - 创建了 `(app)/audit-admin` 路由组，为安全审计员提供专属的前端页面。
    - 包含 `audit-logs`（审计日志）、`login-logs`（登录日志）和 `reports`（报告，此版本为仪表盘）三个子页面。
- **UI 组件**: 使用 Svelte 和 TailwindCSS 构建了数据表格、筛选器、分页和模态框等组件，以实现流畅的审计数据查询和展示体验。
- **权限控制**: 前端通过检查用户的 `role` 字段来动态展示不同的导航菜单和页面。例如，只有 `audit_admin` 角色的用户才能看到“安全审计”菜单项。

---

感谢使用！如果您在部署或使用过程中遇到任何问题，请参考本文档或检查后端的技术细节部分进行排查。
